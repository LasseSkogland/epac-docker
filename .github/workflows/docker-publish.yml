name: Build and Push Custom Image

on:
    schedule:
        - cron: "0 0 * * 1"
    workflow_dispatch:
    push:
        branches: ["main"]
        paths: ["Dockerfile", ".github/workflows/docker-publish.yml"]

env:
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}

jobs:
    build-and-push:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Fetch Latest EPAC Version
              id: get_version
              shell: pwsh
              run: |
                  $module = Find-PSResource -Name EnterprisePolicyAsCode -Repository PSGallery
                  Add-Content -Path $env:GITHUB_OUTPUT -Value "full=$($module.Version.ToString())" -Encoding utf8
                  Add-Content -Path $env:GITHUB_OUTPUT -Value "major_minor=$($module.Version.Major).$($module.Version.Minor)" -Encoding utf8
                  Add-Content -Path $env:GITHUB_OUTPUT -Value "major=$($module.Version.Major)" -Encoding utf8

            - name: Check if image exists
              if: github.event_name == 'schedule'
              id: check_tag
              shell: bash
              run: |
                LOWER_IMAGE=$(echo "${{ env.IMAGE_NAME }}" | tr '[:upper:]' '[:lower:]')
                STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
                    -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                    "https://${{ env.REGISTRY }}/v2/$LOWER_IMAGE/manifests/${{ steps.get_version.outputs.full }}")
                
                if [ "$STATUS" -eq 200 ]; then
                    echo "exists=true" >> $GITHUB_OUTPUT
                    echo "Tag ${{ steps.get_version.outputs.full }} already exists. Skipping build."
                else
                    echo "exists=false" >> $GITHUB_OUTPUT
                    echo "Tag ${{ steps.get_version.outputs.full }} not found. Proceeding with build."
                fi

            - name: Set up Docker Buildx
              if: steps.check_tag.outputs.exists != 'true'
              uses: docker/setup-buildx-action@v3

            - name: Log into registry
              if: steps.check_tag.outputs.exists != 'true'
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract Docker metadata
              if: steps.check_tag.outputs.exists != 'true'
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
                  tags: |
                      type=ref,event=branch
                      type=sha
                      type=raw,value=latest,enable={{is_default_branch}}
                      type=raw,value=${{ steps.get_version.outputs.full }}
                      type=raw,value=${{ steps.get_version.outputs.major_minor }}
                      type=raw,value=${{ steps.get_version.outputs.major }}

            - name: Build and push Docker image
              if: steps.check_tag.outputs.exists != 'true'
              uses: docker/build-push-action@v6
              with:
                  context: .
                  push: true
                  build-args: |
                      EPAC_VERSION=${{ steps.get_version.outputs.full }}
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
